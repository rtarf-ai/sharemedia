<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flex Share Master Pro</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f1f5f9; }
    
    /* Loading Overlay */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      backdrop-filter: blur(4px); transition: opacity 0.5s;
    }

    /* Glass Card */
    .glass-card {
      background: white; border-radius: 24px;
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.5);
    }

    /* Input Styling */
    .input-label { font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 4px; display: block; }
    .input-std {
      width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0;
      background: #f8fafc; transition: all 0.3s ease; font-size: 0.95rem;
    }
    .input-std:focus { border-color: #06c755; background: #fff; ring: 3px; outline: none; box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1); }

    /* Type Button */
    .type-btn { transition: all 0.2s; position: relative; overflow: hidden; }
    .type-btn:active { transform: scale(0.96); }

    /* Animations */
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <div id="loading-overlay">
    <div class="animate-spin rounded-full h-14 w-14 border-4 border-slate-200 border-t-green-500 mb-4"></div>
    <p class="text-slate-500 font-medium animate-pulse">Connecting to LINE...</p>
  </div>

  <div class="glass-card w-full max-w-md p-6 sm:p-8 fade-in relative">
    
    <div class="text-center mb-6">
      <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-green-50 text-green-500 mb-3 shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Flex Share Master</h1>
      <p class="text-slate-400 text-sm mt-1">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ Flex Message ‡πÅ‡∏ö‡∏ö Viral</p>
    </div>

    <div class="grid grid-cols-3 gap-3 mb-6 p-1 bg-slate-100 rounded-2xl">
      <button onclick="setType('image')" id="btn-image" class="type-btn py-2.5 rounded-xl text-sm font-semibold text-slate-500 hover:text-slate-700">üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
      <button onclick="setType('video')" id="btn-video" class="type-btn py-2.5 rounded-xl text-sm font-semibold text-slate-500 hover:text-slate-700">üé• ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠</button>
      <button onclick="setType('json')" id="btn-json" class="type-btn py-2.5 rounded-xl text-sm font-semibold text-slate-500 hover:text-slate-700">üíª JSON</button>
    </div>

    <div id="form-container" class="space-y-4 mb-8 hidden">
      
      <div id="input-image" class="hidden space-y-4 fade-in">
        <div>
          <label class="input-label">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
          <input type="url" id="img-url" class="input-std" placeholder="https://example.com/image.jpg">
        </div>
        <div>
          <label class="input-label">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏£‡∏π‡∏õ)</label>
          <input type="url" id="img-action" class="input-std" placeholder="https://your-website.com">
        </div>
      </div>

      <div id="input-video" class="hidden space-y-4 fade-in">
        <div>
          <label class="input-label">URL ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠ (.mp4)</label>
          <input type="url" id="vid-url" class="input-std" placeholder="https://example.com/video.mp4">
        </div>
        <div>
          <label class="input-label">URL ‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠</label>
          <input type="url" id="vid-preview" class="input-std" placeholder="https://example.com/cover.jpg">
        </div>
      </div>

      <div id="input-json" class="hidden space-y-4 fade-in">
        <div>
          <label class="input-label">‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î JSON (Flex Message Object)</label>
          <textarea id="json-code" rows="6" class="input-std font-mono text-xs bg-slate-50" placeholder='{"type": "bubble", ...}'></textarea>
        </div>
      </div>

      <div class="pt-4 border-t border-slate-100 fade-in">
        <label class="input-label">Alt Text (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)</label>
        <input type="text" id="alt-text" class="input-std" value="‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà üéÅ" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">
      </div>
    </div>

    <button onclick="processAndShare()" id="submit-btn" class="w-full bg-gradient-to-br from-green-500 to-emerald-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-green-500/25 hover:shadow-green-500/40 active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed hidden">
      üì§ ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏•‡∏ô‡πå
    </button>
    
    <p class="text-center text-xs text-slate-300 mt-4">Safe-Zone Enabled for Easy Forwarding</p>

  </div>

  <script>
    // ==========================================
    // ‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (Configuration)
    // ==========================================
    const LIFF_ID = "2008762104-tW1Fyo2F";       // 1. ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxF83NZAmhaWdkL6OweLTIMUqB_19o-aJXA9NasONl5ryYJ6r_oeMgcWwO9D1s9efKS/exec"; // 2. ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App
    // ==========================================

    let currentType = '';
    let userProfile = null;

    // --- 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Initialization) ---
    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        
        // ‡∏ã‡πà‡∏≠‡∏ô Loading ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        const overlay = document.getElementById('loading-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => overlay.style.display = 'none', 500);

        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          userProfile = await liff.getProfile();
        }
      } catch (err) {
        document.getElementById('loading-overlay').style.display = 'none';
        Swal.fire({ icon: 'error', title: 'Init Error', text: err.message });
      }
    }
    main();

    // --- 2. ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° UI (UI Logic) ---
    function setType(type) {
      currentType = type;
      
      // Reset Button Styles
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.className = "type-btn py-2.5 rounded-xl text-sm font-semibold text-slate-500 hover:text-slate-700 hover:bg-slate-50";
      });
      
      // Active Button Style
      const activeBtn = document.getElementById(`btn-${type}`);
      activeBtn.className = "type-btn py-2.5 rounded-xl text-sm font-semibold text-green-600 bg-white shadow-sm ring-1 ring-slate-200";

      // Toggle Inputs
      document.getElementById('form-container').classList.remove('hidden');
      ['image', 'video', 'json'].forEach(t => document.getElementById(`input-${t}`).classList.add('hidden'));
      document.getElementById(`input-${type}`).classList.remove('hidden');

      // Show Submit Button
      document.getElementById('submit-btn').classList.remove('hidden');
    }

    // --- 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message (Content Generation) ---
    function createFlexMessage() {
      const altText = document.getElementById('alt-text').value;
      let bubbleContent = {};

      // üî• Safe Zone Footer: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÅ‡∏ä‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
      const safeZoneFooter = {
        "type": "box",
        "layout": "vertical",
        "contents": [
          { "type": "separator", "color": "#f0f0f0", "margin": "lg" },
          {
            "type": "button",
            "action": { "type": "uri", "label": "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ üöÄ", "uri": `https://liff.line.me/${LIFF_ID}` },
            "style": "link", "height": "sm", "color": "#06c755", "margin": "sm"
          },
          {
            "type": "text", 
            "text": "‡∏Å‡∏î‡πÅ‡∏ä‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ‚§¥Ô∏è", 
            "size": "xxs", "color": "#94a3b8", "align": "center", "margin": "none" 
          }
        ],
        "paddingAll": "md",
        "backgroundColor": "#ffffff"
      };

      if (currentType === 'image') {
        const url = document.getElementById('img-url').value;
        const actionUrl = document.getElementById('img-action').value;
        if (!url) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");

        bubbleContent = {
          "type": "bubble",
          "hero": {
            "type": "image", "url": url, "size": "full", "aspectRatio": "1.91:1", "aspectMode": "cover",
            "action": actionUrl ? { "type": "uri", "uri": actionUrl } : undefined
          },
          // Body ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà Text ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ô Hero ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡πÅ‡∏ï‡πà‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏∑‡∏≠ Footer
          "body": {
            "type": "box", "layout": "vertical", "paddingAll": "none",
            "contents": [] // Empty body hack
          },
          "footer": safeZoneFooter
        };

      } else if (currentType === 'video') {
        const url = document.getElementById('vid-url').value;
        const preview = document.getElementById('vid-preview').value;
        if (!url || !preview) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ URL ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        bubbleContent = {
          "type": "bubble",
          "hero": {
            "type": "video", "url": url, "previewUrl": preview, "aspectRatio": "16:9",
            "altContent": { "type": "image", "size": "full", "aspectRatio": "16:9", "aspectMode": "cover", "url": preview }
          },
          "body": {
            "type": "box", "layout": "vertical", "contents": [
              { "type": "text", "text": "üé• ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "weight": "bold", "size": "sm", "color": "#334155" }
            ],
            "paddingTop": "md", "paddingBottom": "sm", "paddingStart": "md", "paddingEnd": "md"
          },
          "footer": safeZoneFooter
        };

      } else if (currentType === 'json') {
        const jsonStr = document.getElementById('json-code').value;
        if (!jsonStr) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î JSON");
        
        let userJson = JSON.parse(jsonStr);
        // Inject Footer ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Bubble ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Footer
        if (userJson.type === 'bubble' && !userJson.footer) {
          userJson.footer = safeZoneFooter;
        }
        bubbleContent = userJson;
      }

      return {
        type: "flex",
        altText: altText,
        contents: bubbleContent
      };
    }

    // --- 4. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå (Process & Share) ---
    async function processAndShare() {
      if (!liff.isLoggedIn()) { liff.login(); return; }

      try {
        // Build Message
        const message = createFlexMessage();
        
        // Prepare Log Data
        const logData = {
          type: currentType,
          altText: message.altText,
          userId: userProfile ? userProfile.userId : 'unknown',
          contentUrl: currentType === 'image' ? document.getElementById('img-url').value : (currentType === 'video' ? document.getElementById('vid-url').value : 'JSON')
        };

        // Loading
        Swal.fire({
          title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•',
          html: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        // Send to Backend (Fire & Forget)
        if(GAS_API_URL && GAS_API_URL.startsWith('http')) {
            fetch(GAS_API_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(logData)
            }).catch(e => console.log('Log Error:', e));
        }

        // Wait a bit for UX
        await new Promise(r => setTimeout(r, 800));
        Swal.close();

        // Share Target Picker
        if (liff.isApiAvailable('shareTargetPicker')) {
          const res = await liff.shareTargetPicker([message]);
          if (res) {
            Swal.fire({
              icon: 'success',
              title: '‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
              text: '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
              confirmButtonColor: '#06c755'
            });
          }
        } else {
          Swal.fire('Error', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå', 'error');
        }

      } catch (err) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', err.message, 'warning');
      }
    }
  </script>
</body>
</html>

