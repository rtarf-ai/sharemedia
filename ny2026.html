<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Flex Share Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
    .glass-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 9999;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
      transition: opacity 0.3s;
    }
    .hidden-force { display: none !important; }
    .nav-btn.active { background-color: #06c755; color: white; border-color: #06c755; }
  </style>
</head>
<body class="text-gray-800 h-screen flex flex-col items-center justify-center p-4">

  <div id="loader" class="loader-overlay">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-500 mb-4"></div>
    <p class="text-green-600 font-bold text-lg animate-pulse" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</p>
  </div>

  <div id="app-container" class="glass-panel w-full max-w-md p-6 hidden-force">
    
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800"><i class="fab fa-line text-green-500"></i> Flex Share Pro</h1>
      <p class="text-xs text-gray-500 mt-1">External Host Edition</p>
    </div>

    <div class="grid grid-cols-3 gap-2 mb-6">
      <button onclick="switchType('image')" id="btn-image" class="nav-btn active border border-gray-200 py-2 rounded-lg text-sm font-medium transition hover:bg-green-50">
        <i class="fas fa-image mb-1 block"></i> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      </button>
      <button onclick="switchType('video')" id="btn-video" class="nav-btn border border-gray-200 py-2 rounded-lg text-sm font-medium transition hover:bg-green-50">
        <i class="fas fa-video mb-1 block"></i> ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠
      </button>
      <button onclick="switchType('json')" id="btn-json" class="nav-btn border border-gray-200 py-2 rounded-lg text-sm font-medium transition hover:bg-green-50">
        <i class="fas fa-code mb-1 block"></i> JSON
      </button>
    </div>

    <div id="form-content">
      <div id="media-inputs">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">URL ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏∑‡πà‡∏≠</label>
          <input type="url" id="media-url" placeholder="https://..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none transition">
        </div>
        
        <div class="mb-4 hidden" id="preview-image-container">
           <label class="block text-sm font-medium text-gray-700 mb-1">URL ‡∏£‡∏π‡∏õ‡∏õ‡∏Å</label>
           <input type="url" id="preview-url" placeholder="https://..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none transition">
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô</label>
          <select id="media-ratio" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none bg-white">
            <option value="1:1">1:1 (Square)</option>
            <option value="1.51:1">1.51:1 (Standard)</option>
            <option value="16:9">16:9 (Wide)</option>
          </select>
        </div>
      </div>

      <div id="json-inputs" class="hidden-force">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Flex Message JSON</label>
          <textarea id="json-code" rows="6" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none font-mono text-xs"></textarea>
        </div>
      </div>
    </div>

    <button onclick="processAndShare()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transform transition active:scale-95 flex justify-center items-center">
      <i class="fas fa-share-alt mr-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    </button>
  </div>

  <script>
    // --- Configuration ---
    // 1. ‡πÉ‡∏™‡πà LIFF ID ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô LINE Developers
    const LIFF_ID = '2008762104-tW1Fyo2F'; 
    
    // 2. ‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Google Apps Script ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1
    const GAS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxF_ZRJV8znd68PDtRcLfAWbEYfsfCrN8IwlUGxS5otmVl7yqdr7nrdCE48G6SZpvk/exec'; 

    let currentType = 'image';

    // --- Initialization ---
    window.onload = async function() {
      try {
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        if (mode === 'forward') {
          handleAutoForward(urlParams);
        } else {
          document.getElementById('loader').classList.add('hidden-force');
          document.getElementById('app-container').classList.remove('hidden-force');
        }

      } catch (err) {
        showError('LIFF Init Error: ' + err.message);
      }
    };

    function switchType(type) {
      currentType = type;
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-${type}`).classList.add('active');

      const mediaInputs = document.getElementById('media-inputs');
      const jsonInputs = document.getElementById('json-inputs');
      const previewContainer = document.getElementById('preview-image-container');

      if (type === 'json') {
        mediaInputs.classList.add('hidden-force');
        jsonInputs.classList.remove('hidden-force');
      } else {
        mediaInputs.classList.remove('hidden-force');
        jsonInputs.classList.add('hidden-force');
        if(type === 'video') previewContainer.classList.remove('hidden');
        else previewContainer.classList.add('hidden');
      }
    }

    async function processAndShare() {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      try {
        let flexContent, shareUrl;
        // ‡πÉ‡∏ä‡πâ URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÅ‡∏ó‡∏ô liff.line.me ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Redirect ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
        // ‡πÅ‡∏ï‡πà‡πÉ‡∏ô LIFF v2 ‡πÉ‡∏ä‡πâ liff.line.me/ID ‡∏à‡∏∞‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô handle cross-platform
        const baseUrl = `https://liff.line.me/${LIFF_ID}`;

        if (currentType === 'image' || currentType === 'video') {
            const url = document.getElementById('media-url').value;
            const ratio = document.getElementById('media-ratio').value;
            const previewUrl = currentType === 'video' ? document.getElementById('preview-url').value : null;
            
            if(!url) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ URL");

            const payloadData = { type: currentType, url, ratio, previewUrl };
            const payload = encodeURIComponent(JSON.stringify(payloadData));
            shareUrl = `${baseUrl}?mode=forward&payload=${payload}`;
            
            flexContent = createMediaFlex(url, ratio, currentType, shareUrl, previewUrl);
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡πÑ‡∏õ‡∏¢‡∏±‡∏á GAS
            saveLogToGAS(payloadData);

        } else if (currentType === 'json') {
            const rawJson = document.getElementById('json-code').value;
            if(!rawJson) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ JSON");
            let jsonObj = JSON.parse(rawJson);
            
            const payloadData = { type: 'json', data: jsonObj };
            const payload = encodeURIComponent(JSON.stringify(payloadData));
            shareUrl = `${baseUrl}?mode=forward&payload=${payload}`;
            
            flexContent = injectShareButton(jsonObj, shareUrl);
            saveLogToGAS(payloadData);
        }

        Swal.close();
        await shareTargetPicker(flexContent);

      } catch (err) {
        Swal.close();
        showError(err.message);
      }
    }

    async function handleAutoForward(params) {
        const payloadStr = params.get('payload');
        document.getElementById('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠...";
        
        try {
            if(!payloadStr) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const data = JSON.parse(decodeURIComponent(payloadStr));
            const baseUrl = `https://liff.line.me/${LIFF_ID}`;
            const nextShareUrl = `${baseUrl}?mode=forward&payload=${payloadStr}`;
            
            let flexContent;
            if(data.type === 'image') flexContent = createMediaFlex(data.url, data.ratio, 'image', nextShareUrl);
            else if (data.type === 'video') flexContent = createMediaFlex(data.url, data.ratio, 'video', nextShareUrl, data.previewUrl);
            else if (data.type === 'json') flexContent = injectShareButton(data.data, nextShareUrl);

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏Å‡∏≤‡∏£ Forward
            saveLogToGAS({ ...data, action: 'forward' });

            await shareTargetPicker(flexContent);
            liff.closeWindow();

        } catch (err) {
            showError(err.message);
            document.getElementById('loader').classList.add('hidden-force');
            document.getElementById('app-container').classList.remove('hidden-force');
        }
    }

    // --- Backend Connection (Logging) ---
    function saveLogToGAS(data) {
        if (!GAS_SCRIPT_URL || GAS_SCRIPT_URL.includes('YOUR_GAS')) return;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
        liff.getProfile().then(profile => {
            const logData = {
                userId: profile.userId,
                displayName: profile.displayName,
                ...data
            };

            // ‡πÉ‡∏ä‡πâ mode: 'no-cors' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Response ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS
            fetch(GAS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(logData)
            }).catch(e => console.error("Log Error:", e));
        }).catch(e => console.error("Profile Error:", e));
    }

    // --- Flex Builders (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
    function createMediaFlex(url, ratio, type, shareUrl, previewUrl = "") {
        const heroBlock = type === 'image' 
            ? { "type": "image", "url": url, "size": "full", "aspectRatio": ratio, "aspectMode": "cover", "action": { "type": "uri", "uri": url } }
            : { "type": "video", "url": url, "previewUrl": previewUrl, "aspectRatio": ratio, "altContent": { "type": "image", "url": previewUrl, "size": "full", "aspectRatio": ratio, "aspectMode": "cover" }, "action": { "type": "uri", "uri": url } };

        return {
            "type": "flex", "altText": `‡∏™‡πà‡∏á ${type === 'image' ? '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û' : '‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠'}`,
            "contents": {
                "type": "bubble", "hero": heroBlock,
                "body": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏£‡πå‡∏ï‡πà‡∏≠", "align": "center", "color": "#aaaaaa", "size": "xs" }], "paddingAll": "10px" },
                "footer": { "type": "box", "layout": "vertical", "contents": [{ "type": "button", "style": "primary", "height": "sm", "action": { "type": "uri", "label": "‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô üöÄ", "uri": shareUrl }, "color": "#06c755" }], "paddingAll": "10px" }
            }
        };
    }

    function injectShareButton(originalJson, shareUrl) {
        let newJson = JSON.parse(JSON.stringify(originalJson));
        if (newJson.type === 'flex' && newJson.contents && newJson.contents.type === 'bubble') {
            const shareBtn = { "type": "button", "style": "primary", "height": "sm", "margin": "md", "action": { "type": "uri", "label": "‡πÅ‡∏ä‡∏£‡πå‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ üöÄ", "uri": shareUrl }, "color": "#06c755" };
            if (!newJson.contents.footer) newJson.contents.footer = { "type": "box", "layout": "vertical", "contents": [] };
            newJson.contents.footer.contents.push(shareBtn);
        }
        return newJson;
    }

    async function shareTargetPicker(flexMessage) {
        if (liff.isApiAvailable('shareTargetPicker')) {
            const res = await liff.shareTargetPicker([flexMessage]);
            if (res) Swal.fire({ icon: 'success', title: '‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', timer: 1500, showConfirmButton: false });
        } else {
            showError("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Share Target Picker");
        }
    }

    function showError(msg) { Swal.fire({ icon: 'error', title: 'Oops...', text: msg }); }
  </script>
</body>
</html>
