<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pro Flex Share System</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --primary-color: #06c755;
      --primary-hover: #05b34c;
      --bg-color: #f8f9fa;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background-color: var(--bg-color);
      color: #333;
      padding-bottom: 50px;
    }

    /* Card Container */
    .main-card {
      max-width: 600px;
      margin: 30px auto;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.05);
      padding: 30px;
      border: 1px solid rgba(0,0,0,0.02);
    }

    /* Type Selector Tabs */
    .type-selector {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 30px;
      background: #f1f3f5;
      padding: 5px;
      border-radius: 16px;
    }

    .type-tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      color: #868e96;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .type-tab.active {
      background: #fff;
      color: var(--primary-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .type-tab i { margin-bottom: 4px; display: block; font-size: 1.2rem; }

    /* Form Elements */
    .form-label { font-weight: 600; font-size: 0.9rem; color: #495057; }
    .form-control, .form-select {
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #dee2e6;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.1);
    }

    /* Button */
    .btn-share {
      background: var(--primary-color);
      color: white;
      border: none;
      width: 100%;
      padding: 15px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 1.1rem;
      margin-top: 20px;
      box-shadow: 0 10px 20px rgba(6, 199, 85, 0.2);
      transition: all 0.3s;
    }
    .btn-share:hover { background: var(--primary-hover); transform: translateY(-2px); }
    .btn-share:active { transform: translateY(0); }

    /* Utilities */
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Loader */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      z-index: 9999;
      display: none; flex-direction: column;
      justify-content: center; align-items: center;
    }
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
      border-radius: 50%; width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="loader mb-3"></div>
    <div class="text-muted fw-bold">กำลังประมวลผล...</div>
  </div>

  <div class="container">
    <div class="main-card">
      <div class="text-center mb-4">
        <h3 class="fw-bold mb-1">Flex Share Creator</h3>
        <small class="text-muted">สร้างและส่งต่อข้อมูลแบบมืออาชีพ</small>
      </div>

      <div class="type-selector">
        <div class="type-tab active" onclick="switchTab('image')">
          <i class="fas fa-image"></i> รูปภาพ
        </div>
        <div class="type-tab" onclick="switchTab('video')">
          <i class="fas fa-video"></i> วิดีโอ
        </div>
        <div class="type-tab" onclick="switchTab('json')">
          <i class="fas fa-code"></i> JSON
        </div>
      </div>

      <form id="shareForm">
        <div class="mb-3">
          <label class="form-label">ข้อความแจ้งเตือน (Alt Text)</label>
          <input type="text" class="form-control" id="altText" value="คุณได้รับ Flex Message ใหม่" placeholder="ข้อความที่จะขึ้นหน้า Chat list">
        </div>

        <div id="sec-image" class="fade-in">
          <div class="mb-3">
            <label class="form-label">URL รูปภาพ (Direct Link .jpg/.png)</label>
            <input type="url" class="form-control" id="imgUrl" placeholder="https://example.com/image.jpg">
          </div>
          <div class="mb-3">
            <label class="form-label">สัดส่วนภาพ</label>
            <select class="form-select" id="imgRatio">
              <option value="1:1">1:1 (จัตุรัส)</option>
              <option value="1.51:1" selected>1.51:1 (มาตรฐาน)</option>
              <option value="16:9">16:9 (แนวนอน)</option>
              <option value="4:3">4:3 (แนวตั้ง)</option>
            </select>
          </div>
        </div>

        <div id="sec-video" class="hidden fade-in">
          <div class="mb-3">
            <label class="form-label">URL วิดีโอ (.mp4)</label>
            <input type="url" class="form-control" id="videoUrl" placeholder="https://example.com/video.mp4">
          </div>
          <div class="mb-3">
            <label class="form-label">URL รูปปก (Preview Image)</label>
            <input type="url" class="form-control" id="videoPreviewUrl" placeholder="https://example.com/cover.jpg">
          </div>
          <div class="mb-3">
            <label class="form-label">สัดส่วนวิดีโอ</label>
            <select class="form-select" id="videoRatio">
              <option value="16:9">16:9 (แนวนอน)</option>
              <option value="1:1">1:1 (จัตุรัส)</option>
            </select>
          </div>
        </div>

        <div id="sec-json" class="hidden fade-in">
          <div class="mb-3">
            <label class="form-label">Flex Message JSON Object</label>
            <textarea class="form-control" id="jsonCode" rows="6" placeholder='{ "type": "bubble", ... }'></textarea>
            <div class="form-text">* ใส่เฉพาะ Object เริ่มต้นด้วย { และจบด้วย }</div>
          </div>
        </div>

        <button type="button" class="btn-share" onclick="handleProcessAndShare()">
          <i class="fas fa-share-nodes me-2"></i> บันทึกและส่งต่อ
        </button>
      </form>

    </div>
  </div>

  <script>
    // ================= CONFIGURATION =================
    // 1. นำ LIFF ID จาก LINE Developers มาใส่
    const LIFF_ID = "2008762104-X0UncHZQ"; 
    
    // 2. นำ URL จาก Google Apps Script (ที่ลงท้าย /exec) มาใส่
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLLOyxoIkSAHE2-zMGwtQeRPk6MRGZm44XZfzuG2W6opa-F7eAvmFxdSMT-jRlMuo/exec"; 
    // =================================================

    let currentType = 'image';
    let userProfile = null;

    // Initialization
    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          userProfile = await liff.getProfile();
        }
      } catch (err) {
        console.error("LIFF Init Failed", err);
      }
    }
    main();

    // UI Switching
    function switchTab(type) {
      currentType = type;
      // UI Updates
      document.querySelectorAll('.type-tab').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      ['image', 'video', 'json'].forEach(t => {
        document.getElementById(`sec-${t}`).classList.add('hidden');
      });
      document.getElementById(`sec-${currentType}`).classList.remove('hidden');
    }

    // Main Function
    async function handleProcessAndShare() {
      // 1. Check Capabilities
      if (!liff.isApiAvailable('shareTargetPicker')) {
        Swal.fire('Error', 'อุปกรณ์นี้ไม่รองรับการแชร์แบบ Target Picker', 'error');
        return;
      }

      toggleLoading(true);

      try {
        // 2. Data Preparation
        const altText = document.getElementById('altText').value.trim() || 'Flex Message';
        let flexContent = null;
        let payload = {
          userId: userProfile?.userId || 'U_Unknown',
          displayName: userProfile?.displayName || 'Guest',
          type: currentType,
          content: '',
          ratio: ''
        };

        // 3. Content Generation
        if (currentType === 'image') {
          const url = document.getElementById('imgUrl').value.trim();
          const ratio = document.getElementById('imgRatio').value;
          if (!url) throw new Error("กรุณาระบุ URL รูปภาพ");
          
          payload.content = url;
          payload.ratio = ratio;
          flexContent = createMediaBubble('image', url, null, ratio);

        } else if (currentType === 'video') {
          const vUrl = document.getElementById('videoUrl').value.trim();
          const pUrl = document.getElementById('videoPreviewUrl').value.trim();
          const ratio = document.getElementById('videoRatio').value;
          if (!vUrl || !pUrl) throw new Error("กรุณาระบุ URL วิดีโอและรูปปก");

          payload.content = vUrl;
          payload.ratio = ratio;
          flexContent = createMediaBubble('video', vUrl, pUrl, ratio);

        } else if (currentType === 'json') {
          const rawJson = document.getElementById('jsonCode').value.trim();
          if (!rawJson) throw new Error("กรุณาระบุโค้ด JSON");
          
          payload.content = 'Custom JSON Data';
          try {
            flexContent = JSON.parse(rawJson);
          } catch(e) {
            throw new Error("รูปแบบ JSON ไม่ถูกต้อง");
          }
        }

        // 4. Inject Viral Button (For Image/Video)
        if (currentType !== 'json') {
          flexContent = injectViralButton(flexContent);
        }

        // 5. Send Log to Google Sheets (Fire and Forget style via fetch no-cors)
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', // สำคัญ: เพื่อให้ผ่าน Cross-Origin
          cache: 'no-cache',
          headers: { 'Content-Type': 'text/plain' }, // ส่งเป็น Plain text เพื่อหลีกเลี่ยง Preflight
          body: JSON.stringify(payload)
        });

        // 6. Launch Share Target Picker
        const res = await liff.shareTargetPicker([
          {
            type: "flex",
            altText: altText,
            contents: flexContent
          }
        ]);

        toggleLoading(false);

        if (res) {
          Swal.fire({ icon: 'success', title: 'ส่งเรียบร้อย!', timer: 2000, showConfirmButton: false });
        } 

      } catch (error) {
        toggleLoading(false);
        Swal.fire('แจ้งเตือน', error.message, 'warning');
      }
    }

    // Helper: Create Bubble
    function createMediaBubble(mode, mainUrl, previewUrl, ratio) {
      let hero = {};
      
      if (mode === 'image') {
        hero = {
          type: "image",
          url: mainUrl,
          size: "full",
          aspectRatio: ratio,
          aspectMode: "cover",
          action: { type: "uri", uri: mainUrl }
        };
      } else {
        hero = {
          type: "video",
          url: mainUrl,
          previewUrl: previewUrl,
          altContent: {
             type: "image", size: "full", aspectRatio: ratio, aspectMode: "cover", url: previewUrl
          },
          aspectRatio: ratio
        };
      }

      return {
        type: "bubble",
        hero: hero
        // Body ไม่มีก็ได้ เน้นรูป
      };
    }

    // Helper: Inject Viral Button
    function injectViralButton(bubble) {
      if (bubble.type !== 'bubble') return bubble; // รองรับเฉพาะ Bubble เดี่ยวเบื้องต้น

      const viralBtn = {
        type: "box",
        layout: "vertical",
        contents: [
          { type: "separator", margin: "sm" },
          {
            type: "button",
            action: {
              type: "uri",
              label: "✨ สร้างแบบนี้บ้าง",
              uri: "https://liff.line.me/" + LIFF_ID // ลิงก์กลับมาแอปเดิม
            },
            height: "sm",
            style: "link",
            color: "#06c755"
          }
        ],
        paddingAll: "none",
        backgroundColor: "#ffffff"
      };

      // เช็คว่ามี footer หรือยัง
      if (!bubble.footer) {
        bubble.footer = viralBtn;
      } else {
        // ถ้ามี footer เดิม ให้เติมปุ่มต่อท้าย
        if (!bubble.footer.contents) bubble.footer.contents = [];
        bubble.footer.contents.push(viralBtn.contents[0]); // separator
        bubble.footer.contents.push(viralBtn.contents[1]); // button
      }
      return bubble;
    }

    function toggleLoading(show) {
      document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }
  </script>
</body>
</html>
