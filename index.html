<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Share System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f0f2f5; }
    /* Custom Scrollbar for Textarea */
    textarea::-webkit-scrollbar { width: 8px; }
    textarea::-webkit-scrollbar-track { background: #f1f1f1; }
    textarea::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    textarea::-webkit-scrollbar-thumb:hover { background: #555; }
    
    .tab-btn { transition: all 0.3s ease; border-bottom: 3px solid transparent; }
    .tab-active { border-color: #06C755; color: #06C755; font-weight: 600; background-color: rgba(6, 199, 85, 0.05); }
    .tab-inactive { color: #6B7280; }
  </style>
</head>
<body class="text-gray-800 antialiased pb-24">

  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-3"></div>
    <p class="text-white font-medium tracking-wide">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
  </div>

  <div class="max-w-lg mx-auto bg-white min-h-screen shadow-xl relative">
    
    <div class="bg-gradient-to-r from-[#06C755] to-[#04a746] text-white pt-8 pb-6 px-6 rounded-b-[2rem] shadow-lg mb-4">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold">Share Center</h1>
          <p class="text-xs text-green-100 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏•‡∏ô‡πå</p>
        </div>
        <div id="user-profile" class="hidden flex flex-col items-end">
          <img id="user-img" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
          <span id="user-name" class="text-xs mt-1 font-light">Loading...</span>
        </div>
      </div>
    </div>

    <div class="flex px-2 mb-4">
      <button onclick="switchTab('image')" id="tab-image" class="tab-btn tab-active flex-1 py-3 rounded-t-lg text-sm">
        üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      </button>
      <button onclick="switchTab('video')" id="tab-video" class="tab-btn tab-inactive flex-1 py-3 rounded-t-lg text-sm">
        üé• ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠
      </button>
      <button onclick="switchTab('json')" id="tab-json" class="tab-btn tab-inactive flex-1 py-3 rounded-t-lg text-sm">
        üíª JSON
      </button>
    </div>

    <div class="px-6 space-y-6">

      <div id="form-image" class="animate-fade-in">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ / Title</label>
            <input type="text" id="img-title" class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</label>
            <input type="url" id="img-url" oninput="updatePreview('img')" class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="https://example.com/photo.jpg">
          </div>
          <div class="relative w-full aspect-video bg-gray-100 rounded-xl overflow-hidden border border-dashed border-gray-300 flex items-center justify-center">
            <img id="img-preview" src="" class="hidden w-full h-full object-cover">
            <span id="img-placeholder" class="text-gray-400 text-sm">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>
          </div>
        </div>
      </div>

      <div id="form-video" class="hidden animate-fade-in">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠</label>
            <input type="text" id="vid-title" class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏õ‡∏Å (Thumbnail)</label>
            <input type="url" id="vid-thumb" oninput="updatePreview('vid')" class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="https://.../cover.jpg">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠ (.mp4)</label>
            <input type="url" id="vid-url" class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="https://.../video.mp4">
          </div>
          <div class="relative w-full aspect-video bg-gray-100 rounded-xl overflow-hidden border border-dashed border-gray-300 flex items-center justify-center group">
            <img id="vid-preview" src="" class="hidden w-full h-full object-cover opacity-80">
            <div id="vid-icon" class="hidden absolute bg-black bg-opacity-50 rounded-full p-3">
               <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
            </div>
            <span id="vid-placeholder" class="text-gray-400 text-sm">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏õ‡∏Å</span>
          </div>
        </div>
      </div>

      <div id="form-json" class="hidden animate-fade-in">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">JSON Flex Message (Bubble)</label>
          <div class="relative">
             <textarea id="json-code" rows="10" class="w-full rounded-xl border border-gray-300 px-4 py-3 font-mono text-xs bg-gray-900 text-green-400 focus:ring-2 focus:ring-green-500 outline-none" placeholder='{"type": "bubble", "body": { ... }}'></textarea>
          </div>
          <p class="text-xs text-gray-500 mt-2 text-right">*‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Object ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô contents</p>
        </div>
      </div>

    </div>

    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-gray-200 max-w-lg mx-auto">
      <button onclick="handleShare()" class="w-full bg-[#06C755] hover:bg-[#05a848] text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-green-200 transform transition-all active:scale-95 flex justify-center items-center gap-2">
        <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
        </svg>
      </button>
    </div>

  </div>

  <script>
    // ================= CONFIGURATION =================
    const LIFF_ID = '2008762104-HjyWLKYy'; // üî¥ ‡πÉ‡∏™‡πà LIFF ID ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzMcWiMOwGhtKfXbvmykmw0uRjVzF6LEiT4lMloN1xpg7LmP_OrCT1-zdxuYbEjW0RJ/exec'; // üî¥ ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    // =================================================

    let currentType = 'image';
    let userProfile = null;

    // 1. Initialize System
    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          // Get Profile
          userProfile = await liff.getProfile();
          document.getElementById('user-profile').classList.remove('hidden');
          document.getElementById('user-name').innerText = userProfile.displayName;
          document.getElementById('user-img').src = userProfile.pictureUrl;
        }
      } catch (err) {
        console.error("LIFF Init Error", err);
        Swal.fire('Error', 'LIFF Initialization failed.', 'error');
      }
    }
    main();

    // 2. Tab Switching
    function switchTab(type) {
      currentType = type;
      // UI Updates
      ['image', 'video', 'json'].forEach(t => {
        const btn = document.getElementById(`tab-${t}`);
        const form = document.getElementById(`form-${t}`);
        if(t === type) {
          btn.className = 'tab-btn tab-active flex-1 py-3 rounded-t-lg text-sm';
          form.classList.remove('hidden');
        } else {
          btn.className = 'tab-btn tab-inactive flex-1 py-3 rounded-t-lg text-sm';
          form.classList.add('hidden');
        }
      });
    }

    // 3. Preview Logic
    function updatePreview(prefix) {
      const urlInput = prefix === 'img' ? 'img-url' : 'vid-thumb';
      const previewImg = document.getElementById(`${prefix}-preview`);
      const placeholder = document.getElementById(`${prefix}-placeholder`);
      const url = document.getElementById(urlInput).value;

      if(url) {
        previewImg.src = url;
        previewImg.classList.remove('hidden');
        placeholder.classList.add('hidden');
        if(prefix === 'vid') document.getElementById('vid-icon').classList.remove('hidden');
      } else {
        previewImg.classList.add('hidden');
        placeholder.classList.remove('hidden');
        if(prefix === 'vid') document.getElementById('vid-icon').classList.add('hidden');
      }
    }

    // 4. Main Share Logic
    async function handleShare() {
      // Validation
      if (!liff.isLoggedIn()) { await liff.login(); return; }
      if (!liff.isApiAvailable('shareTargetPicker')) {
        Swal.fire('‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÅ‡∏ä‡∏£‡πå', 'warning');
        return;
      }

      document.getElementById('loadingOverlay').classList.remove('hidden');

      try {
        let flexContent;
        let logData = {
           userId: userProfile ? userProfile.userId : 'unknown',
           type: currentType,
           title: '',
           url: ''
        };

        // Construct Content based on Type
        if (currentType === 'image') {
          const title = document.getElementById('img-title').value;
          const url = document.getElementById('img-url').value;
          if(!url) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
          flexContent = getBubbleImage(title, url);
          logData.title = title;
          logData.url = url;

        } else if (currentType === 'video') {
          const title = document.getElementById('vid-title').value;
          const thumb = document.getElementById('vid-thumb').value;
          const vidUrl = document.getElementById('vid-url').value;
          if(!vidUrl || !thumb) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
          flexContent = getBubbleVideo(title, thumb, vidUrl);
          logData.title = title;
          logData.url = vidUrl;

        } else {
          const jsonStr = document.getElementById('json-code').value;
          if(!jsonStr) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà JSON Code");
          flexContent = JSON.parse(jsonStr);
          logData.title = "Custom JSON";
        }

        // Call Share Target Picker
        const pickerResult = await liff.shareTargetPicker([
          {
            type: "flex",
            altText: logData.title || "‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì",
            contents: flexContent
          }
        ]);

        if (pickerResult) {
          // Success: Send Log to Google Sheet
          sendLogToBackend(logData);
          
          Swal.fire({
            icon: 'success',
            title: '‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
            confirmButtonColor: '#06C755'
          });
        } else {
          console.log("User closed picker");
        }

      } catch (error) {
        console.error(error);
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: error.message || '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
          confirmButtonColor: '#d33'
        });
      } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    }

    // 5. Backend Connection (Fetch to GAS)
    function sendLogToBackend(data) {
      // ‡πÉ‡∏ä‡πâ mode: 'no-cors' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î Block (‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô response ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
      fetch(GAS_API_URL, {
        method: 'POST',
        mode: 'no-cors', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).catch(err => console.error("Log Error:", err));
    }

    // 6. Flex Message Templates (‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° Modern)
    function getBubbleImage(title, url) {
      return {
        "type": "bubble",
        "hero": {
          "type": "image",
          "url": url,
          "size": "full",
          "aspectRatio": "20:13",
          "aspectMode": "cover",
          "action": { "type": "uri", "uri": url }
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            { "type": "text", "text": title || "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", "weight": "bold", "size": "xl", "wrap": true }
          ]
        },
        "footer": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            { "type": "button", "style": "secondary", "action": { "type": "uri", "label": "‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û", "uri": url } }
          ]
        }
      };
    }

    function getBubbleVideo(title, thumb, url) {
       return {
          "type": "bubble",
          "hero": {
            "type": "image",
            "url": thumb,
            "size": "full",
            "aspectRatio": "20:13",
            "aspectMode": "cover",
            "action": { "type": "uri", "uri": url }
          },
          "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
              { "type": "text", "text": title || "‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ", "weight": "bold", "size": "xl", "wrap": true },
              {
                "type": "image",
                "url": "https://cdn-icons-png.flaticon.com/512/727/727245.png",
                "position": "absolute", "offsetTop": "60px", "offsetStart": "0px", "offsetEnd": "0px", "align": "center", "size": "xs"
              }
            ]
          },
          "footer": {
            "type": "box",
            "layout": "vertical",
            "contents": [
               { "type": "button", "style": "primary", "color": "#E1306C", "action": { "type": "uri", "label": "‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠", "uri": url } }
            ]
          }
       };
    }
  </script>
</body>
</html>
